#!/bin/bash

set -eux

export INSTACK_ROOT=${INSTACK_ROOT:-$(pwd)}

export ELEMENTS_PATH="$INSTACK_ROOT/tripleo-image-elements/elements:$INSTACK_ROOT/diskimage-builder/elements:$INSTACK_ROOT/instack-undercloud/elements" 

export JSONFILE=$INSTACK_ROOT/instack-undercloud/json-files/fedora-20-undercloud-source.json

sudo yum -y install git python-pip

git config --global user.email "instack@example.com"
git config --global user.name "instack"

if [ ! -d $INSTACK_ROOT/tripleo-image-elements/elements ]; then
    git clone https://git.openstack.org/openstack/tripleo-image-elements
    
    pushd tripleo-image-elements
    # https://review.openstack.org/#/c/101784/5
    git fetch https://review.openstack.org/openstack/tripleo-image-elements refs/changes/84/101784/5 && git cherry-pick FETCH_HEAD
    # https://review.openstack.org/#/c/101117/6
    git fetch https://review.openstack.org/openstack/tripleo-image-elements refs/changes/17/101117/6 && git cherry-pick FETCH_HEAD
    # https://review.openstack.org/#/c/91704/11/
    git fetch https://review.openstack.org/openstack/tripleo-image-elements refs/changes/04/91704/12 && git cherry-pick FETCH_HEAD
    # https://review.openstack.org/#/c/102687/3
    git fetch https://review.openstack.org/openstack/tripleo-image-elements refs/changes/87/102687/3 && git cherry-pick FETCH_HEAD
    popd
fi

if [ ! -d $INSTACK_ROOT/diskimage-builder/elements ]; then
    git clone https://git.openstack.org/openstack/diskimage-builder

    pushd diskimage-builder
    # https://review.openstack.org/#/c/105543/
    git fetch https://review.openstack.org/openstack/diskimage-builder refs/changes/43/105543/1 && git cherry-pick FETCH_HEAD
    popd
fi


if [ ! -d $INSTACK_ROOT/instack-undercloud/elements ]; then
    git clone https://github.com/agroup/instack-undercloud
fi

if [ ! -d $INSTACK_ROOT/instack ]; then
    git clone https://github.com/agroup/instack
fi

pushd $INSTACK_ROOT/diskimage-builder
sudo pip install -e .
popd 

pushd $INSTACK_ROOT/instack
sudo pip install -e .
popd

# openstack-tripleo still required so we can generate passwords in
# instack-install-undercloud-packages
sudo yum install -y http://rdo.fedorapeople.org/openstack-icehouse/rdo-release-icehouse.rpm
sudo yum install -y openstack-tripleo

$INSTACK_ROOT/instack-undercloud/scripts/instack-install-undercloud-packages
