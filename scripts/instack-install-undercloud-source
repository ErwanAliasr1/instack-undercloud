#!/bin/bash

set -eux

export INSTACK_ROOT=${INSTACK_ROOT:-$(pwd)}

export ELEMENTS_PATH="$INSTACK_ROOT/tripleo-image-elements/elements:$INSTACK_ROOT/diskimage-builder/elements:$INSTACK_ROOT/instack-undercloud/elements" 

export JSONFILE=$INSTACK_ROOT/instack-undercloud/json-files/fedora-20-undercloud-source.json

sudo yum -y install git python-pip

git config --global user.email "instack@example.com"
git config --global user.name "instack"


if [ ! -d $INSTACK_ROOT/tripleo-image-elements/elements ]; then
    git clone https://git.openstack.org/openstack/tripleo-image-elements
    
    pushd tripleo-image-elements

    if [ "$LKG" = "1" ]; then
        git fetch origin $DIB_REPOREF_tripleo_image_elements
        git reset --hard FETCH_HEAD
    fi

    # https://review.openstack.org/#/c/91704
    git fetch https://review.openstack.org/openstack/tripleo-image-elements refs/changes/04/91704/12 && git cherry-pick FETCH_HEAD
    # https://review.openstack.org/#/c/102687
    git fetch https://review.openstack.org/openstack/tripleo-image-elements refs/changes/87/102687/3 && git cherry-pick FETCH_HEAD
    # https://review.openstack.org/#/c/99242
    git fetch https://review.openstack.org/openstack/tripleo-image-elements refs/changes/42/99242/7 && git cherry-pick FETCH_HEAD
    # https://review.openstack.org/#/c/106909
    git fetch https://review.openstack.org/openstack/tripleo-image-elements refs/changes/09/106909/3 && git cherry-pick FETCH_HEAD
    # https://review.openstack.org/#/c/107232
    git fetch https://review.openstack.org/openstack/tripleo-image-elements refs/changes/32/107232/1 && git cherry-pick FETCH_HEAD
    # https://review.openstack.org/#/c/106908/
    git fetch https://review.openstack.org/openstack/tripleo-image-elements refs/changes/08/106908/1 && git cherry-pick FETCH_HEAD
    # https://review.openstack.org/#/c/107234
    git fetch https://review.openstack.org/openstack/tripleo-image-elements refs/changes/34/107234/1 && git cherry-pick FETCH_HEAD
    popd
fi

if [ ! -d $INSTACK_ROOT/diskimage-builder/elements ]; then
    git clone https://git.openstack.org/openstack/diskimage-builder

    pushd diskimage-builder

    if [ "$LKG" = "1" ]; then
        git fetch origin $DIB_REPOREF_diskimage_builder
        git reset --hard FETCH_HEAD
    fi

    # https://review.openstack.org/#/c/105543/
    git fetch https://review.openstack.org/openstack/diskimage-builder refs/changes/43/105543/1 && git cherry-pick FETCH_HEAD
    popd
fi


if [ ! -d $INSTACK_ROOT/instack-undercloud/elements ]; then
    git clone https://github.com/agroup/instack-undercloud
fi

if [ ! -d $INSTACK_ROOT/instack ]; then
    git clone https://github.com/agroup/instack
fi

if [ ! -d $INSTACK_ROOT/os-cloud-config ]; then
    git clone https://git.openstack.org/openstack/os-cloud-config

    pushd os-cloud-config

    if [ "$LKG" = "1" ]; then
        git fetch origin $DIB_REPOREF_os_cloud_config
        git reset --hard FETCH_HEAD
    fi

    popd

fi

if [ ! -d $INSTACK_ROOT/tripleo-incubator ]; then
    git clone https://git.openstack.org/openstack/tripleo-incubator
fi

if [ ! -d $INSTACK_ROOT/tripleo-heat-templates ]; then
    git clone https://git.openstack.org/openstack/tripleo-heat-templates
fi

pushd $INSTACK_ROOT/diskimage-builder
sudo pip install -U .
popd 

pushd $INSTACK_ROOT/instack
sudo pip install -e .
popd

# Needed to compile os-cloud-config
sudo yum install -y libffi-devel gcc python-devel openssl-devel libxml2-devel libxslt-devel
pushd $INSTACK_ROOT/os-cloud-config
sudo pip install -e .
popd

# tar is required if we want to run diskimage-builder
sudo yum install -y tar

$INSTACK_ROOT/instack-undercloud/scripts/instack-install-undercloud-packages

# Reset ownership of cache directory
# This is needed in order for instack-build-images to make changes to the cache
sudo -E chown -R $USER: $HOME/.cache/image-create
