#!/bin/bash

export INSTACK_ROOT=${INSTACK_ROOT:-$(pwd)}
export TRIPLEO_ROOT=$INSTACK_ROOT

export PATH=$PATH:$INSTACK_ROOT/instack-undercloud:$INSTACK_ROOT/instack-undercloud/scripts:$INSTACK_ROOT/diskimage-builder/bin

export RUN_INSTACK=${RUN_INSTACK:-1}
export TRIPLEO_OS_DISTRO=fedora
export TRIPLEO_OS_FAMILY=redhat
export TE_DATAFILE=instack.json
export IMG_SOURCE_URL=http://file.rdu.redhat.com/~jslagle/tripleo-images-juno-source/

# Using delorean packages is the default
export DELOREAN=${DELOREAN:-1}
# Using LKG is the default
export LKG=1

export COMPLETION_MESSAGE="\
#############################################################################
install-undercloud complete.

The file containing this installation's passwords is at
/root/tripleo-undercloud-passwords.

There is also a stackrc file at /root/stackrc.

These files are needed to interact with the OpenStack services, and should be
secured. For convenience, they can be copied to the current directory:

sudo cp /root/tripleo-undercloud-passwords .
sudo cp /root/stackrc .

#############################################################################"

if [ "$LKG" = "1" ]; then
    export DELOREAN_REPO=http://209.132.178.33/repos/64/77/64777f2fe3a2329674bbfaa0fb102bd2a420c529/delorean.repo
else
    export DELOREAN_REPO=http://209.132.178.33/repos/current/delorean.repo
fi

export PIP_DOWNLOAD_CACHE=~/.cache/pip

if [ "$LKG" = "1" ]; then
    # These are set manually, since they're not part of source-repositories
    export DIB_REPOREF_tripleo_image_elements=00957cad1395dff0d750eaeaf089d26b08df9712
    export DIB_REPOREF_tripleo_heat_templates=b2e3a746d4b40b9db5462d1b001ffa25c895acb9
    export DIB_REPOREF_diskimage_builder=60fdfb26dccc919ef7e3cbaa14657c3c8c7ebc5c
    export DIB_REPOREF_os_cloud_config=4a03e6b129c91a7269b6103a1f85fd011ec92c91
    export DIB_REPOREF_tripleo_incubator=e3d474c49dd91aede1e7d39d85b84d5c826ebb86

    # To generate these, run:
    # tripleo set-source-vars -m /etc/dib-manifests/dib-manifest-git-instack
    # after a successful installation.
    export DIB_REPOREF_ceilometer=25dbd23fcc6e1eefd4b2df4bff1cbcc6460a8d79
    export DIB_REPOLOCATION_ceilometer=https://git.openstack.org/openstack/ceilometer
    export DIB_REPOREF_eventlet=04dba9a34fb6706b680052097f9e39d905a831d0
    export DIB_REPOLOCATION_eventlet=https://github.com/jan-g/eventlet.git
    export DIB_REPOREF_glance=2e7de07c5a7c8f9d11c00499f7e85ac30f71d025
    export DIB_REPOLOCATION_glance=https://git.openstack.org/openstack/glance.git
    export DIB_REPOREF_heat=d7e91a1bc39019c1212de5eead24b0af380e71ec
    export DIB_REPOLOCATION_heat=https://git.openstack.org/openstack/heat.git
    export DIB_REPOREF_horizon=035b9868c323a1602f6dd770151de59398d50ff8
    export DIB_REPOLOCATION_horizon=https://git.openstack.org/openstack/horizon
    export DIB_REPOREF_ironic=47036441136cbfa5bc2b9db834e7747cd0525a86
    export DIB_REPOLOCATION_ironic=https://git.openstack.org/openstack/ironic
    export DIB_REPOREF_keystone=67b474f4ba3428eca97a4a6faaaba5951253f236
    export DIB_REPOLOCATION_keystone=https://git.openstack.org/openstack/keystone.git
    export DIB_REPOREF_neutron=735d6779b880fca87b7619a8e831fe686b1e67e9
    export DIB_REPOLOCATION_neutron=https://git.openstack.org/openstack/neutron.git
    export DIB_REPOREF_nova=1dcdfd1d2b05418fea101877d53ab9daa610552d
    export DIB_REPOLOCATION_nova=https://git.openstack.org/openstack/nova.git
    export DIB_REPOREF_novnc=960752ea5308ea5aacd5a350b2ad45dcf999a608
    export DIB_REPOLOCATION_novnc=https://github.com/kanaka/noVNC.git
    export DIB_REPOREF_python_ceilometerclient=4cef2bf39a377759e22042609abb35aaad2da2b4
    export DIB_REPOLOCATION_python_ceilometerclient=https://git.openstack.org/openstack/python-ceilometerclient.git
    export DIB_REPOREF_python_cinderclient=8e87c0b600d0742fbdd69ab770dbeb9dca7cf58c
    export DIB_REPOLOCATION_python_cinderclient=https://git.openstack.org/openstack/python-cinderclient.git
    export DIB_REPOREF_python_glanceclient=6dda6f306f44f68c437176428eb041d4fd862505
    export DIB_REPOLOCATION_python_glanceclient=https://git.openstack.org/openstack/python-glanceclient.git
    export DIB_REPOREF_python_heatclient=4bc53acd078265066a0f71ebe0890785cdca59b3
    export DIB_REPOLOCATION_python_heatclient=https://git.openstack.org/openstack/python-heatclient.git
    export DIB_REPOREF_python_ironicclient=62a3905f3e0c8ef9ad99281015e9d9a99f597bd7
    export DIB_REPOLOCATION_python_ironicclient=https://git.openstack.org/openstack/python-ironicclient.git
    export DIB_REPOREF_python_keystoneclient=1643f7da32b1f729f12d042565d8c67f10f91b8c
    export DIB_REPOLOCATION_python_keystoneclient=https://git.openstack.org/openstack/python-keystoneclient.git
    export DIB_REPOREF_python_neutronclient=f22dbd20446ef5d316ffd3fffb630cf2731b8229
    export DIB_REPOLOCATION_python_neutronclient=https://git.openstack.org/openstack/python-neutronclient.git
    export DIB_REPOREF_python_novaclient=3fa05957daa44de7d16e0f1930b36dd6791dc1cd
    export DIB_REPOLOCATION_python_novaclient=https://git.openstack.org/openstack/python-novaclient.git
    export DIB_REPOREF_python_swiftclient=d13441d26244cc0947b85287d3fba298cb532c9a
    export DIB_REPOLOCATION_python_swiftclient=https://git.openstack.org/openstack/python-swiftclient.git


fi

export ELEMENTS_PATH="\
$INSTACK_ROOT/instack-undercloud/elements:\
$INSTACK_ROOT/tripleo-image-elements/elements/:\
$INSTACK_ROOT/diskimage-builder/elements/"

export DEPLOY_IMAGE_ELEMENT=deploy-ironic
export DEPLOY_NAME=deploy-ramdisk-ironic

export DEPLOY_DIB_EXTRA_ARGS=""
export DISCOVERY_DIB_EXTRA_ARGS=""

export OVERCLOUD_CONTROL_DIB_EXTRA_ARGS="\
baremetal \
base \
boot-stack \
ceilometer-agent-central \
ceilometer-agent-notification \
ceilometer-api \
ceilometer-collector \
cinder-api \
cinder-lio \
cinder-volume \
common-venv \
dhcp-all-interfaces \
haproxy \
horizon \
hosts \
keepalived \
mariadb-rpm \
neutron-network-node \
ntp \
os-collect-config \
pip-cache \
rabbitmq-server \
snmpd \
stable-interface-names \
stackuser \
swift-proxy \
swift-storage \
use-ephemeral \
selinux-policy-updates
"

export OVERCLOUD_COMPUTE_DIB_EXTRA_ARGS="\
baremetal \
base \
common-venv \
dhcp-all-interfaces \
hosts \
neutron-openvswitch-agent \
nova-compute \
nova-kvm \
ntp \
os-collect-config \
pip-cache \
pypi-openstack \
snmpd \
stable-interface-names \
stackuser \
use-ephemeral
"

export OVERCLOUD_CINDER_DIB_EXTRA_ARGS="\
baremetal \
base \
cinder-lio \
cinder-volume \
common-venv \
dhcp-all-interfaces \
hosts \
neutron-openvswitch-agent \
ntp \
os-collect-config \
pip-cache \
pypi-openstack \
snmpd \
stable-interface-names \
stackuser \
use-ephemeral \
"

export OVERCLOUD_SWIFT_DIB_EXTRA_ARGS="\
baremetal \
base \
common-venv \
dhcp-all-interfaces \
hosts \
neutron-openvswitch-agent \
ntp \
os-collect-config \
pip-cache \
pypi-openstack \
snmpd \
stable-interface-names \
stackuser \
swift-storage \
use-ephemeral \
"

if [ "$DELOREAN" = "1" ]; then
    export DIB_COMMON_ELEMENTS=${DIB_COMMON_ELEMENTS:-""}
    export DIB_COMMON_ELEMENTS="$DIB_COMMON_ELEMENTS delorean undercloud-package-install"

    # Delorean is patched but there isn't a new build yet.
    export OVERCLOUD_CONTROL_DIB_EXTRA_ARGS="$OVERCLOUD_CONTROL_DIB_EXTRA_ARGS glance-wsme"
fi
